# Build application on release creation and attach produced files to the Release.
name: Build Release Assets

on:
  workflow_dispatch:
    inputs:
    
  release:
    types: [created]

permissions:
  contents: write

jobs:
  build-and-attach:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [macos-latest, ubuntu-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: npm ci

      - name: Run maker (build packages)
        run: npm run make

      - name: Upload assets to release (safe)
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          set -euo pipefail
      
          # debug: show what tag we're using
          TAG="${GITHUB_REF_NAME:-${GITHUB_REF##*/}}"
          echo "Using tag: $TAG"
      
          REPO="$GITHUB_REPOSITORY"
          API="https://api.github.com/repos/$REPO"
      
          # Ensure jq is available for JSON parsing
          if ! command -v jq >/dev/null 2>&1; then
            echo "Installing jq..."
            sudo apt-get update -y
            sudo apt-get install -y jq
          fi
      
          # Try to get an existing release by tag
          http_status=$(curl -s -o /tmp/release.json -w "%{http_code}" \
            -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github+json" \
            "$API/releases/tags/$TAG" || true)
      
          if [ "$http_status" = "200" ]; then
            release_id=$(jq -r .id /tmp/release.json)
            upload_url=$(jq -r .upload_url /tmp/release.json)
            echo "Found existing release id=$release_id"
          else
            echo "Release for tag $TAG not found (HTTP $http_status). Creating release..."
            body=$(jq -n --arg tag "$TAG" --arg name "$TAG" '{ tag_name: $tag, name: $name, draft: false, prerelease: false }')
            create_resp=$(curl -s -H "Authorization: token $GITHUB_TOKEN" -H "Accept: application/vnd.github+json" -d "$body" "$API/releases")
            release_id=$(echo "$create_resp" | jq -r .id)
            upload_url=$(echo "$create_resp" | jq -r .upload_url)
            echo "Created release id=$release_id"
          fi
      
          # upload_url has the template form "https://uploads.github.com/â€¦{?name,label}"
          upload_url=${upload_url%\{*}
      
          # Upload all files under out/make/**
          files=$(find out/make -type f 2>/dev/null)
          if [ -z "$files" ]; then
            echo "No files found in out/make to upload"
            exit 0
          fi
      
          for f in "${files[@]}"; do
            [ -f "$f" ] || continue
            filename=$(basename "$f")
            echo "Uploading $filename ..."
            curl -s -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Content-Type: application/octet-stream" \
              --data-binary @"$f" \
              "$upload_url?name=$(printf '%s' "$filename" | jq -s -R -r @uri"")" \
              | jq -r '.url // "upload_response_no_url"'
          done
